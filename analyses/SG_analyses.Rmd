---
title: "SG_analyses"
author: "Sabrina Grant"
date: "`r Sys.Date()`"
output: html_document
---

#packages
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

# packages
install.packages("librarian")
librarian::shelf("tidyverse", "vegan", "ggplot2", "dplyr", "car", "ggpubr", "minpack.lm", "googledrive", "janitor", "nlme", "RColorBrewer", "splitstackshape", "lubridate", "matrixStats", "readr", "stringr", "broom")

library(googledrive)

```
#loading data
```{r}

# load data
drive_deauth()

drive_auth(scopes = "https://www.googleapis.com/auth/drive")

file <- drive_find("kelp_recovery_data.rda",
                   shared_drive = "MBA_kelp_recovery_research")
file

drive_download(
  as_id(file$id),
  path = "kelp_recovery_data.rda",
  overwrite = TRUE
)

load("kelp_recovery_data.rda")
ls()
```


#Fixing up data frames
```{r}
###averaging counts and % cover per transect

# Helper function to get the most common value (mode)
get_mode <- function(x) {
  ux <- na.omit(unique(x))
  ux[which.max(tabulate(match(x, ux)))]
}

quad_transect_avgs <- quad_data %>%
  group_by(site, site_type, zone, survey_date, transect) %>%
  summarise(
    across(where(is.numeric) & !any_of("quadrat"), ~ mean(.x, na.rm = TRUE)),
    substrate = get_mode(substrate),
    .groups = "drop"
  )


# View result
print(quad_transect_avgs)

#now averaging per survey 
quad_avgs <- quad_transect_avgs %>%
  group_by(site, site_type, zone, survey_date) %>%
  summarise( 
    across(where(is.numeric) & !any_of("transect"), ~mean(.x, na.rm = TRUE)), 
    substrate = get_mode(substrate), 
    .groups = "drop")

# View result
print(quad_avgs)

#now making a new column to represent urchin behavior i.e. how many urchins are actively grazing 


#averaging transects
kelp_avgs <- kelp_data %>%
  group_by(site, site_type, zone, survey_date) %>%
  summarise( 
    across(where(is.numeric) & !any_of("transect"), ~mean(.x, na.rm = TRUE)), 
    .groups = "drop") 



```



#Merging Quad/Kelp/Macro Dfs

```{r}
merged_data <- kelp_avgs %>%
  mutate(site = if_else(site == "RECO_04", "REC_04", site)) %>%
  left_join(quad_avgs, by = c("site", "site_type", "zone", "survey_date"))

#creating a new column that just has years for future analysis  
merged_data$year <- as.numeric(format(merged_data$survey_date, "%Y"))
  

```

#2024 data 
```{r}
#normalizing 2024 data 

year_one_data <- merged_data %>% 
  filter(year == 2024) %>%
  filter() %>%
  dplyr::select(year, site, zone, site_type, macro_stipe_density_20m2, everything())

year_one_data[sapply(year_one_data, is.numeric)] <-
  lapply(year_one_data[sapply(year_one_data, is.numeric)],
         function(x) { x[is.na(x)] <- 0; x })

year_one_data %>%
  group_by(site, site_type, zone, year) %>%
  summarise(across(where(is.numeric), mean, na.rm = TRUE), .groups = "drop")
  
```


##LDA at the depth zone level
```{r}
library(MASS)

year_one_data$site_type <- as.factor(year_one_data$site_type)
  
# Identify columns that contain "20m2"
cols_to_scale <- grep("20m2", names(year_one_data), value = TRUE)

# Divide those columns by 20
year_one_data[cols_to_scale] <- lapply(year_one_data[cols_to_scale], function(x) x / 20)

# 3. Rename those columns by removing "20m2_"
names(year_one_data)[names(year_one_data) %in% cols_to_scale] <-
  gsub("20m2","", cols_to_scale)

lda_model <- lda(site_type ~ macro_stipe_density_ + density_ptecal + density_nerlue + density_lamset + density_eisarb + purple_urchin_densitym2 + purple_urchin_conceiledm2 + lamr_densitym2 + macr_densitym2 + macj_densitym2 + nerj_densitym2 + ptej_densitym2 + lsetj_densitym2  + cov_articulated_coralline + cov_crustose_coralline + cov_encrusting_red + cov_fleshy_red + cov_stephanocystis + cov_dictyoneurum_spp  + cov_desmarestia_spp + cov_lam_holdfast_live + cov_mac_holdfast_live + cov_bare_rock + cov_bare_sand + cov_shell_debris, data = year_one_data)


#lda figure
plot(lda_model)

#lda summary
lda_model

#getting predictions etc etc 
pred <- predict(lda_model)

pred_class <- pred$class

#ACCURACY = 85.42
library(caret)
confusionMatrix(pred_class, year_one_data$site_type)

results <- year_one_data %>%
  mutate(predicted = pred_class, 
         match = site_type == predicted)

#seeing mismatches 
results <- results %>%
  dplyr::select(year, site, zone, site_type, predicted, match, everything())

mismatches <- results %>% filter(!match)

mismatches

results 


```


###coefficients of LDA
```{r}
library(tidyr)

# Get coefficients into tidy format
coef_df <- as.data.frame(lda_model$scaling)
coef_df$variable <- rownames(coef_df)
coef_long <- pivot_longer(coef_df, cols = c(LD1, LD2), names_to = "LD", values_to = "coefficient")

# Plot
ggplot(coef_long, aes(x = reorder(variable, coefficient), y = coefficient, fill = LD)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  theme_minimal(base_size = 14) +
  labs(
    title = "LDA Coefficients by Discriminant Function",
    x = "Variable",
    y = "Coefficient"
  ) +
  scale_fill_brewer(palette = "Set1")

#aesthetically pleasing figure

#renaming variables and selecting for strong coefficients
rename_vars <- c(
  "density_eisarb"        = "E. arborea",
  "macj_densitym2"        = "M. pyrifera juvenile",
  "lsetj_densitym2"       = "L. setchellii juvenile",
  "lamr_densitym2"        = "Laminariales recruit", 
  "ptej_densitym2"        = "P. californica juvenile", 
  "density_ptecal"        = "P. californica", 
  "cov_dictyoneurum_spp"  = "Dictyoneurum spp.", 
  "cov_mac_holdfast_live" = "M. pyrifera holdfast", 
  "macro_stipe_density_"= "M. pyrifera", 
  "macr_densitym2"        = "M. pyrifera recruit", 
  "density_nerlue"        = "N. luetkeana", 
  "nerj_densitym2"        = "N. luetkeana juvenile"
)

coef_strong <- coef_long %>%
  filter(abs(coefficient) > 1) %>%
  mutate(
    variable = recode_factor(variable, !!!rename_vars),
    variable = reorder(variable, abs(coefficient))
  )



ggplot(coef_strong, aes(
  x = variable,
  y = coefficient,
  fill = LD
)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  coord_flip() +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "top",
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  ) +
  labs(
    title = "LDA Coefficients by Discriminant Function",
    x = "Variable",
    y = "Coefficient"
  ) +
  scale_fill_brewer(palette = "Set1")

```

#FIG 1: LDA of 2024 Patch Discrimination
```{r}
library(ggplot2)
library(dplyr)
library(MASS)
library(grid)  # for arrows

# Get LDA scores 

lda_scores <- as.data.frame(predict(lda_model)$x) 
lda_scores$site_type <- year_one_data$site_type 

# Plot LD1 vs LD2 

ggplot(lda_scores, aes(x = LD1, y = LD2, color = site_type, shape = site_type)) + geom_point(size = 3.5, alpha = 0.9) + 
  stat_ellipse(level = 0.95, size = 1, alpha = 0.6) + 
  scale_color_brewer(palette = "Set1") + 
  theme_minimal(base_size = 16) + 
  labs( title = "Linear Discriminant Analysis", subtitle = "95% confidence ellipses by site type", x = paste0("LD1 (", round(lda_model$svd[1]^2 / sum(lda_model$svd^2) * 100, 1), "%)"), y = paste0("LD2 (", round(lda_model$svd[2]^2 / sum(lda_model$svd^2) * 100, 1), "%)"), color = "Site Type", shape = "Site Type" ) + 
  theme( plot.title = element_text(face = "bold", size = 20, hjust = 0.5, margin = margin(b = 10)), plot.subtitle = element_text(size = 14, hjust = 0.5, margin = margin(b = 15)), axis.title = element_text(face = "bold", size = 15), axis.text = element_text(size = 13), legend.title = element_text(face = "bold", size = 14), legend.text = element_text(size = 12), panel.grid.minor = element_blank(), panel.grid.major = element_line(color = "grey85", linewidth = 0.3) )


```



##2025 data
##creating new df
```{r}
#filtering to just select for 2025 data 
year_two_data <- merged_data %>% 
  filter(year == 2025) %>%
  filter() %>%
  dplyr::select(year, site, zone, site_type, macro_stipe_density_20m2, everything())

  
# Identify columns that contain "20m2"
cols_to_scale <- grep("20m2", names(year_two_data), value = TRUE)

# Divide those columns by 20
year_two_data[cols_to_scale] <- lapply(year_two_data[cols_to_scale], function(x) x / 20)

# 3. Rename those columns by removing "20m2_"
names(year_two_data)[names(year_two_data) %in% cols_to_scale] <-
  gsub("20m2","", cols_to_scale)


year_two_data[sapply(year_two_data, is.numeric)] <-
  lapply(year_two_data[sapply(year_two_data, is.numeric)],
         function(x) { x[is.na(x)] <- 0; x })

year_two_data %>%
  group_by(site, site_type, zone, year) %>%
  summarise(across(where(is.numeric), mean, na.rm = TRUE), .groups = "drop")
  

print(year_two_data)
```

##using 2024 LDA to predict 2025
```{r}

library(MASS)
library(dplyr)

#predicting 2025 patch types based on model
pred_2025 <- predict(lda_model, newdata = year_two_data)

year_two_data <- year_two_data %>%
  dplyr::mutate(site_type_pred = pred_2025$class) %>%
  dplyr::select(year, site, zone, site_type, site_type_pred, dplyr::everything())


#setting up the 2024 df with the predictions column 
pred_2024 <- predict(lda_model, newdata = year_one_data)
year_one_data$site_type_pred <- pred_2024$class

year_one_data <- year_one_data %>%
  dplyr::mutate(site_type_pred = pred_2024$class) %>%
  dplyr::select(year, site, zone, site_type, site_type_pred, dplyr::everything())


##REJOINING 2024 AND 2025 DFS

# Rename the column first
year_one_renamed <- year_one_data %>%
  dplyr::rename(site_type_pred_2024 = site_type_pred) %>%
  dplyr::select(site, zone, site_type, site_type_pred_2024)

year_two_renamed <- year_two_data %>%
  dplyr::rename(site_type_pred_2025 = site_type_pred) %>%
  dplyr::select(site, zone, site_type, site_type_pred_2025)

#merge
merged <- dplyr::left_join(year_one_renamed, year_two_renamed, by = c("site", "zone", "site_type"))


#cross-tabulate 2024 predictions with 2025
library(dplyr)

merged <- year_one_data %>%
  dplyr::select(site, zone, site_type, site_type_pred_2024 = site_type_pred) %>%
  left_join(
    year_two_data %>%
      dplyr::select(site, zone, site_type, site_type_pred_2025 = site_type_pred),
    by = c("site", "zone", "site_type")
  )

cross_tab <- table(merged$site_type_pred_2024, merged$site_type_pred_2025)

cross_tab
```

#FIG 2: Heatmap of Predicted Patch Transitions
```{r}
library(ggplot2)
library(reshape2)
library(viridis)

# Melt the table
cross_tab_melt <- reshape2::melt(cross_tab)

# changing the order of the variables for my plot
desired_order_2024 <- c("BAR", "INCIP", "FOR") 
desired_order_2025 <- c("BAR", "INCIP", "FOR")  

# Convert to factors with specified levels
cross_tab_melt$Var1 <- factor(cross_tab_melt$Var1, levels = desired_order_2024)
cross_tab_melt$Var2 <- factor(cross_tab_melt$Var2, levels = desired_order_2025)

#map colors
my_colors <- brewer.pal(11, "Blues")


# Sleek publication-ready heatmap
ggplot(cross_tab_melt, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "grey90", linewidth = 0.3) +
  geom_text(aes(label = value), 
            color = ifelse(cross_tab_melt$value > max(cross_tab_melt$value)/2, "white", "black"), 
            size = 5, fontface = "bold") +
 scale_fill_gradientn(colors = my_colors) +
  labs(
    x = "2024 Predicted Patch Type",
    y = "2025 Predicted Patch Type",
    title = "Transition of Predicted Patch Types from 2024 to 2025",
    fill = "Count"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 13),
    axis.text.y = element_text(face = "bold", size = 13),
    axis.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 18, margin = margin(b = 10)),
    legend.title = element_text(face = "bold", size = 13),
    legend.text = element_text(size = 12),
    panel.grid = element_blank()
  )


```



#Creating Patch Transition DFs
```{r}
library(dplyr)
library(tidyr)

merged_clean_data <- merged_data %>% 
  dplyr::select(year, site, zone, site_type, macro_stipe_density_20m2, everything()) %>%
  mutate(across(where(is.numeric), ~ replace_na(., 0))) %>%   # replace NAs with 0
  group_by(site, site_type, zone, year) %>%
  summarise(across(where(is.numeric), mean), .groups = "drop") %>%
  mutate(site_type = as.factor(site_type))

# scale 20m2 cols to per-m²
cols_to_scale <- grep("20m2", names(merged_clean_data), value = TRUE)
merged_clean_data[cols_to_scale] <- lapply(merged_clean_data[cols_to_scale], function(x) x / 20)

# rename columns (remove "20m2")
names(merged_clean_data) <- gsub("20m2", "", names(merged_clean_data))


###including the predicted patch definitons to the df

#Create unique patch ID using site, predicted 2024 type, and zone
merged <- merged %>%
  mutate(
    patch_id = paste(site, site_type_pred_2024, zone, sep = "_"),
    pred_patch_2024 = site_type_pred_2024,
    pred_patch_2025 = site_type_pred_2025
  ) 

#creating df that has abundances and patch transitions
pred_patch_data <- merged_clean_data %>%
  left_join(
    merged %>%
      dplyr::select(site, zone, site_type, pred_patch_2024, pred_patch_2025),  # match original site_type
    by = c("site", "zone", "site_type")
  ) %>%
  dplyr::select(pred_patch_2024, pred_patch_2025, everything(), -site_type) #move to front and remove original site_type


####creating new df with patch transitions
patch_trans_data <- pred_patch_data %>%
  mutate(
    # assign the correct prediction for each year
    pred_patch = case_when(
      year == 2024 ~ as.character(pred_patch_2024),
      year == 2025 ~ as.character(pred_patch_2025),
      TRUE ~ NA_character_
    ),
    # create the transition column
    patch_transition = paste(pred_patch_2024, "→", pred_patch_2025)
  ) %>%
  # drop the old wide prediction columns, keep everything else (including species)
  dplyr::select(site, zone, year, pred_patch, patch_transition, everything(), -pred_patch_2024, -pred_patch_2025)


```
#A) BAR -> INCIP
```{r}
# Barren → Incipient
bar_incip <- patch_trans_data %>%
  filter(str_detect(patch_transition, "BAR.*→ INCIP"))
glimpse(bar_incip)
```
#B) INCIP -> FOR
```{r}
# Barren → Incipient
incip_for <- patch_trans_data %>%
  filter(str_detect(patch_transition, "INCIP.*→ FOR"))
print(incip_for)
```
#C) BAR -> FOR
```{r}
bar_for <- patch_trans_data %>%
  filter(str_detect(patch_transition, "BAR.*→ FOR"))
view(bar_for)
```

#SIMPER
##A)
###Z-scored all species
```{r}
# Select numeric species/cover columns
species_cols <- grep("^density_|^cov_|macro_stipe|m2", names(bar_incip), value = TRUE)
comm_scaled <- bar_incip[, species_cols] %>%
  mutate(across(everything(), ~ . / max(., na.rm = TRUE))) %>%
  mutate(across(everything(), ~ replace_na(., 0))) 

# Grouping factor (you could use year or site if needed)
group <- as.factor(bar_incip$year)  # e.g., compare 2024 vs 2025 within BAR → INCIP


# Run SIMPER
sim <- simper(comm_scaled, group, permutations = 0, trace = FALSE)

# Summarize SIMPER results
sim_summary <- summary(sim, ordered = TRUE, digits = 3)

# View top contributing species
sim_summary
```
```{r}
# Convert SIMPER summary to a dataframe
sim_df <- as.data.frame(sim_summary$`2024_2025`)  # adjust the contrast name if different
sim_df$species <- rownames(sim_df)  # add species column
sim_df <- sim_df %>%
  arrange(desc(average)) %>%  # sort by contribution
  mutate(cumsum = cumsum(average))  # recalc cumulative if needed

# --- 1️⃣ Create a top-10 table ---
top_species <- sim_df %>% 
  slice_head(n = 10) %>%
  dplyr::select(species, average, sd, ratio, ava, avb, cumsum)

print(top_species)  # view in console


# Plot density contributions
ggplot(top_species, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Top SIMPER contributors: BAR → INCIP",
       x = "Species (z-scored)",
       y = "Average contribution") +
  theme_minimal()
```
###Density species
```{r}
#just selecting for density species 
density_cols <- grep("^density_|macro_stipe|m2", names(bar_incip), value = TRUE)

#SIMPER on density
comm_density <- bar_incip[, density_cols]
group <- as.factor(bar_incip$year)  # comparing 2024 vs 2025

sim_density <- simper(comm_density, group, permutations = 0, trace = FALSE)
sim_density_summary <- summary(sim_density, ordered = TRUE, digits = 3)

# Convert to data frame
sim_density_df <- as.data.frame(sim_density_summary$`2024_2025`)
sim_density_df$species <- rownames(sim_density_df)
sim_density_df <- sim_density_df %>% arrange(desc(average))

# Top 10 density contributors
top_density <- sim_density_df %>% slice_head(n = 10)
print(top_density)

# Plot density contributions
ggplot(top_density, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Top SIMPER contributors (density): BAR → INCIP",
       x = "Species",
       y = "Average contribution") +
  theme_minimal()

```
###Cover species
```{r}
#just selecting for % cover species
cover_cols <- grep("^cov_", names(bar_incip), value = TRUE)

# SIMPER on %cover
comm_cover <- bar_incip[, cover_cols]
group <- as.factor(bar_incip$year)  # comparing 2024 vs 2025

sim_cover <- simper(comm_cover, group, permutations = 0, trace = FALSE)
sim_cover_summary <- summary(sim_cover, ordered = TRUE, digits = 3)

# Convert to data frame for table/plot
sim_cover_df <- as.data.frame(sim_cover_summary$`2024_2025`)
sim_cover_df$species <- rownames(sim_cover_df)
sim_cover_df <- sim_cover_df %>% arrange(desc(average))

# Top 10 %cover contributors
top_cover <- sim_cover_df %>% slice_head(n = 10)
print(top_cover)

# Plot %cover contributions
ggplot(top_cover, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Top SIMPER contributors (%cover): BAR → INCIP",
       x = "Species",
       y = "Average contribution") +
  theme_minimal()
```

##B)
###Z-scored all species
```{r}
# Select numeric species/cover columns
species_cols <- grep("^density_|^cov_|macro_stipe|m2", names(incip_for), value = TRUE)
comm_scaled <- incip_for[, species_cols] %>%
  mutate(across(everything(), ~ . / max(., na.rm = TRUE))) %>%
  mutate(across(everything(), ~ replace_na(., 0))) 

# Grouping factor (you could use year or site if needed)
group <- as.factor(incip_for$year)  # e.g., compare 2024 vs 2025 within BAR → INCIP


# Run SIMPER
sim <- simper(comm_scaled, group, permutations = 0, trace = FALSE)

# Summarize SIMPER results
sim_summary <- summary(sim, ordered = TRUE, digits = 3)

# View top contributing species
sim_summary

# Convert SIMPER summary to a dataframe
sim_df <- as.data.frame(sim_summary$`2024_2025`)  # adjust the contrast name if different
sim_df$species <- rownames(sim_df)  # add species column
sim_df <- sim_df %>%
  arrange(desc(average)) %>%  # sort by contribution
  mutate(cumsum = cumsum(average))  # recalc cumulative if needed

# --- 1️⃣ Create a top-10 table ---
top_species <- sim_df %>% 
  slice_head(n = 10) %>%
  dplyr::select(species, average, sd, ratio, ava, avb, cumsum)

print(top_species)  # view in console


# Plot density contributions
ggplot(top_species, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "forestgreen") +
  coord_flip() +
  labs(title = "Top SIMPER contributors: INCIP → FOR",
       x = "Species (z-scored)",
       y = "Average contribution") +
  theme_minimal()
```
###Density species
```{r}
#just selecting for density species 
density_cols <- grep("^density_|macro_stipe|m2", names(incip_for), value = TRUE)

#SIMPER on density
comm_density <- incip_for[, density_cols]
group <- as.factor(incip_for$year)  # comparing 2024 vs 2025

sim_density <- simper(comm_density, group, permutations = 0, trace = FALSE)
sim_density_summary <- summary(sim_density, ordered = TRUE, digits = 3)

# Convert to data frame
sim_density_df <- as.data.frame(sim_density_summary$`2024_2025`)
sim_density_df$species <- rownames(sim_density_df)
sim_density_df <- sim_density_df %>% arrange(desc(average))

# Top 10 density contributors
top_density <- sim_density_df %>% slice_head(n = 10)
print(top_density)

# Plot density contributions
ggplot(top_density, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "forestgreen") +
  coord_flip() +
  labs(title = "Top SIMPER contributors (density): INCIP → FOR",
       x = "Species",
       y = "Average contribution") +
  theme_minimal()

```
###Cover species
```{r}
#just selecting for % cover species
cover_cols <- grep("^cov_", names(incip_for), value = TRUE)

# SIMPER on %cover
comm_cover <- incip_for[, cover_cols]
group <- as.factor(incip_for$year)  # comparing 2024 vs 2025

sim_cover <- simper(comm_cover, group, permutations = 0, trace = FALSE)
sim_cover_summary <- summary(sim_cover, ordered = TRUE, digits = 3)

# Convert to data frame for table/plot
sim_cover_df <- as.data.frame(sim_cover_summary$`2024_2025`)
sim_cover_df$species <- rownames(sim_cover_df)
sim_cover_df <- sim_cover_df %>% arrange(desc(average))

# Top 10 %cover contributors
top_cover <- sim_cover_df %>% slice_head(n = 10)
print(top_cover)

# Plot %cover contributions
ggplot(top_cover, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "forestgreen") +
  coord_flip() +
  labs(title = "Top SIMPER contributors (%cover): INCIP → FOR",
       x = "Species",
       y = "Average contribution") +
  theme_minimal()
```

##C)
###Z-scored all species
```{r}
# Select numeric species/cover columns
species_cols <- grep("^density_|^cov_|macro_stipe|m2", names(bar_for), value = TRUE)
comm_scaled <- bar_for[, species_cols] %>%
  mutate(across(everything(), ~ . / max(., na.rm = TRUE))) %>%
  mutate(across(everything(), ~ replace_na(., 0))) 

# Grouping factor (you could use year or site if needed)
group <- as.factor(bar_for$year)  # e.g., compare 2024 vs 2025 within BAR → INCIP


# Run SIMPER
sim <- simper(comm_scaled, group, permutations = 0, trace = FALSE)

# Summarize SIMPER results
sim_summary <- summary(sim, ordered = TRUE, digits = 3)

# View top contributing species
sim_summary

# Convert SIMPER summary to a dataframe
sim_df <- as.data.frame(sim_summary$`2024_2025`)  # adjust the contrast name if different
sim_df$species <- rownames(sim_df)  # add species column
sim_df <- sim_df %>%
  arrange(desc(average)) %>%  # sort by contribution
  mutate(cumsum = cumsum(average))  # recalc cumulative if needed

# --- 1️⃣ Create a top-10 table ---
top_species <- sim_df %>% 
  slice_head(n = 10) %>%
  dplyr::select(species, average, sd, ratio, ava, avb, cumsum)

print(top_species)  # view in console


# Plot density contributions
ggplot(top_species, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "coral2") +
  coord_flip() +
  labs(title = "Top SIMPER contributors: BAR → FOR",
       x = "Species (z-scored)",
       y = "Average contribution") +
  theme_minimal()
```
###Density species
```{r}
#just selecting for density species 
density_cols <- grep("^density_|macro_stipe|m2", names(bar_for), value = TRUE)

#SIMPER on density
comm_density <- bar_for[, density_cols]
group <- as.factor(bar_for$year)  # comparing 2024 vs 2025

sim_density <- simper(comm_density, group, permutations = 0, trace = FALSE)
sim_density_summary <- summary(sim_density, ordered = TRUE, digits = 3)

# Convert to data frame
sim_density_df <- as.data.frame(sim_density_summary$`2024_2025`)
sim_density_df$species <- rownames(sim_density_df)
sim_density_df <- sim_density_df %>% arrange(desc(average))

# Top 10 density contributors
top_density <- sim_density_df %>% slice_head(n = 10)
print(top_density)

# Plot density contributions
ggplot(top_density, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "coral2") +
  coord_flip() +
  labs(title = "Top SIMPER contributors (density): BAR → FOR",
       x = "Species",
       y = "Average contribution") +
  theme_minimal()

```
###Cover species
```{r}
#just selecting for % cover species
cover_cols <- grep("^cov_", names(bar_for), value = TRUE)

# SIMPER on %cover
comm_cover <- bar_for[, cover_cols]
group <- as.factor(bar_for$year)  # comparing 2024 vs 2025

sim_cover <- simper(comm_cover, group, permutations = 0, trace = FALSE)
sim_cover_summary <- summary(sim_cover, ordered = TRUE, digits = 3)

# Convert to data frame for table/plot
sim_cover_df <- as.data.frame(sim_cover_summary$`2024_2025`)
sim_cover_df$species <- rownames(sim_cover_df)
sim_cover_df <- sim_cover_df %>% arrange(desc(average))

# Top 10 %cover contributors
top_cover <- sim_cover_df %>% slice_head(n = 10)
print(top_cover)

# Plot %cover contributions
ggplot(top_cover, aes(x = reorder(species, average), y = average)) +
  geom_bar(stat = "identity", fill = "coral2") +
  coord_flip() +
  labs(title = "Top SIMPER contributors (%cover):  BAR → FOR",
       x = "Species",
       y = "Average contribution") +
  theme_minimal()
```


#Bar Graphs
##A)
###Plot
```{r}

# 1. Summarize density and cover by patch_transition, zone, site, year
individual_sp <- bar_incip %>%
  group_by(patch_transition, zone, site, year) %>%
  summarise(across(
    c(macro_stipe_density_.x, macj_densitym2, macr_densitym2, density_nerlue, nerj_densitym2,
      density_ptecal, ptej_densitym2, lamr_densitym2, density_lamset, lsetj_densitym2,
      purple_urchin_densitym2, purple_urchin_conceiledm2, cov_articulated_coralline,
      cov_crustose_coralline, cov_encrusting_red, cov_fleshy_red, cov_stephanocystis,
      cov_desmarestia_spp),
    sum,
    .names = "{.col}"
  )) %>%
  rename(
    macrocystis_adults = macro_stipe_density_.x,
    macrocystis_juveniles = macj_densitym2,
    macrocystis_recruits = macr_densitym2,
    nereocystis_adults = density_nerlue,
    nereocystis_juveniles = nerj_densitym2,
    pterygophora_adults = density_ptecal,
    pterygophora_juveniles = ptej_densitym2,
    laminariales_spp_recruits = lamr_densitym2,
    lam_setchellii_adults = density_lamset,
    lam_setchellii_juveniles = lsetj_densitym2,
    total_purple_urchins = purple_urchin_densitym2,
    conceiled_purple_urchins = purple_urchin_conceiledm2,
    articulated_coralline = cov_articulated_coralline,
    crustose_coralline = cov_crustose_coralline,
    encrusting_red = cov_encrusting_red,
    fleshy_reds = cov_fleshy_red,
    stephanocystis_adult = cov_stephanocystis,
    desmerestia_spp = cov_desmarestia_spp
  ) %>%
  ungroup()

# 2. Pivot longer
indv_long <- individual_sp %>%
  pivot_longer(
    cols = macrocystis_adults:desmerestia_spp,
    names_to = "individual_species",
    values_to = "value"
  ) %>%
  mutate(value_log = log1p(value))  # log-transform for skewed counts

# 3. Define groups
cover_species <- c("articulated_coralline", "crustose_coralline", "encrusting_red",
                   "fleshy_reds", "stephanocystis_adult", "desmerestia_spp")
urchins <- c("total_purple_urchins", "conceiled_purple_urchins")

algae <- c(  "laminariales_spp_recruits",
  "lam_setchellii_juveniles", 
  "pterygophora_juveniles", 
  "lam_setchellii_adults", 
  "pterygophora_adults", 
  "nereocystis_juveniles", 
  "nereocystis_adults", 
  "macrocystis_recruits", 
  "macrocystis_juveniles", 
  "macrocystis_adults")

```
####Macroalgae 
```{r}
# 4. Filter algae density only (exclude cover & urchins)
alg_density_long <- indv_long %>%
  filter(!individual_species %in% c(cover_species, urchins))

# Define species order for plotting
species_order <- c(  "laminariales_spp_recruits",
  "lam_setchellii_juveniles", 
  "pterygophora_juveniles", 
  "lam_setchellii_adults", 
  "pterygophora_adults", 
  "nereocystis_juveniles", 
  "nereocystis_adults", 
  "macrocystis_recruits", 
  "macrocystis_juveniles", 
  "macrocystis_adults")

alg_density_long <- alg_density_long %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


algal_density_summary <- alg_density_long %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

# Prepare data for tornado plot
algal_density_tornado_1 <- algal_density_summary %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(algal_density_tornado_1, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "#d62728", "2025" = "forestgreen")) +
  labs(
    title = "BAR -> INCIP",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "Mean Density (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85")
  )
```

####Cover algae
```{r}
# 4. Filter algae density only (exclude cover & urchins)
cov_density_long <- indv_long %>%
  filter(!individual_species %in% c(algae, urchins))

# Define species order for plotting
species_order <- c(
  "articulated_coralline", "crustose_coralline", "encrusting_red",
                   "fleshy_reds", "stephanocystis_adult", "desmerestia_spp"
)

cov_density_long <- cov_density_long %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


cov_density_summary <- cov_density_long %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

# Prepare data for tornado plot
cov_density_tornado_1 <- cov_density_summary %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(cov_density_tornado_1, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "#d62728", "2025" = "forestgreen")) +
  labs(
    title = "BAR -> INCIP",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "% Cover (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85"))

```
####Urchin
```{r}
# 4. Filter algae density only (exclude cover & urchins)
urch_density_long <- indv_long %>%
  filter(!individual_species %in% c(algae, cover_species))

# Define species order for plotting
species_order <- c("total_purple_urchins", "conceiled_purple_urchins")

urch_density_long <- urch_density_long %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


urch_density_summary <- urch_density_long %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

# Prepare data for tornado plot
urch_density_tornado_1 <- urch_density_summary %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(urch_density_tornado_1, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "#d62728", "2025" = "forestgreen")) +
  labs(
    title = "BAR -> INCIP",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "Mean Density (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85"))

```
###Stats (ANOVA)
```{r}
anova_check_log <- function(df) {
  # ANOVA model for each species
  aov_model <- aov(value ~ factor(year), data = df)
  res <- residuals(aov_model)
  shapiro_p <- tryCatch(shapiro.test(res)$p.value, error = function(e) NA)
  levene_p <- tryCatch(leveneTest(value ~ factor(year), data = df)$`Pr(>F)`[1], 
                        error = function(e) NA)
  
  # If assumptions fail, log-transform and rerun
  if(is.na(shapiro_p) | is.na(levene_p) | shapiro_p <= 0.05 | levene_p <= 0.05) {
    df <- df %>% mutate(value = log(value + 1))
    aov_model <- aov(value ~ factor(year), data = df)
    res <- residuals(aov_model)
    shapiro_p <- tryCatch(shapiro.test(res)$p.value, error = function(e) NA)
    levene_p <- tryCatch(leveneTest(value ~ factor(year), data = df)$`Pr(>F)`[1], 
                          error = function(e) NA)
    transformed <- TRUE
  } else {
    transformed <- FALSE
  }
  
  # Extract ANOVA results
  tidy_res <- broom::tidy(aov_model) %>% filter(term == "factor(year)")
  f_val <- tidy_res$statistic
  p_val <- tidy_res$p.value
  
  tibble(
    individual_species = unique(df$individual_species),
    shapiro_p = shapiro_p,
    levene_p = levene_p,
    transformed = transformed,
    F_value = f_val,
    p_value = p_val
  )
}

# Apply function to all species
anova_summary <- indv_long %>%
  group_by(individual_species) %>%
  group_modify(~ anova_check_log(.x)) %>%
  ungroup()

# View results
anova_summary

# Format ANOVA summary for the table
anova_table <- anova_summary %>%
  dplyr::select(individual_species, F_value, p_value, transformed) %>%
  mutate(p_value = signif(p_value, 3))  # Round p-values

# Create a table figure
ggtexttable(anova_table,
            rows = NULL,       # remove row names
            theme = ttheme("classic"))
```


##B)
###Plot
```{r}

# 1. Summarize density and cover by patch_transition, zone, site, year
individual_sp_for <- incip_for %>%
  group_by(patch_transition, zone, site, year) %>%
  summarise(across(
    c(macro_stipe_density_.x, macj_densitym2, macr_densitym2, density_nerlue, nerj_densitym2,
      density_ptecal, ptej_densitym2, lamr_densitym2, density_lamset, lsetj_densitym2,
      purple_urchin_densitym2, purple_urchin_conceiledm2, cov_articulated_coralline,
      cov_crustose_coralline, cov_encrusting_red, cov_fleshy_red, cov_stephanocystis,
      cov_desmarestia_spp),
    sum,
    .names = "{.col}"
  )) %>%
  rename(
    macrocystis_adults = macro_stipe_density_.x,
    macrocystis_juveniles = macj_densitym2,
    macrocystis_recruits = macr_densitym2,
    nereocystis_adults = density_nerlue,
    nereocystis_juveniles = nerj_densitym2,
    pterygophora_adults = density_ptecal,
    pterygophora_juveniles = ptej_densitym2,
    laminariales_spp_recruits = lamr_densitym2,
    lam_setchellii_adults = density_lamset,
    lam_setchellii_juveniles = lsetj_densitym2,
    total_purple_urchins = purple_urchin_densitym2,
    conceiled_purple_urchins = purple_urchin_conceiledm2,
    articulated_coralline = cov_articulated_coralline,
    crustose_coralline = cov_crustose_coralline,
    encrusting_red = cov_encrusting_red,
    fleshy_reds = cov_fleshy_red,
    stephanocystis_adult = cov_stephanocystis,
    desmerestia_spp = cov_desmarestia_spp
  ) %>%
  ungroup()

# 2. Pivot longer
indv_long_for <- individual_sp_for %>%
  pivot_longer(
    cols = macrocystis_adults:desmerestia_spp,
    names_to = "individual_species",
    values_to = "value"
  ) %>%
  mutate(value_log = log1p(value))  # log-transform for skewed counts

# 3. Define groups
cover_species <- c("articulated_coralline", "crustose_coralline", "encrusting_red",
                   "fleshy_reds", "stephanocystis_adult", "desmerestia_spp")
urchins <- c("total_purple_urchins", "conceiled_purple_urchins")

algae <- c(
  "laminariales_spp_recruits",
  "lam_setchellii_juveniles", 
  "pterygophora_juveniles", 
  "lam_setchellii_adults", 
  "pterygophora_adults", 
  "nereocystis_juveniles", 
  "nereocystis_adults", 
  "macrocystis_recruits", 
  "macrocystis_juveniles", 
  "macrocystis_adults"
)

```
####Macroalgae
```{r}
# 4. Filter algae density only (exclude cover & urchins)
alg_density_long_for <- indv_long_for %>%
  filter(!individual_species %in% c(cover_species, urchins))

# Define species order for plotting
species_order <- c(
  "laminariales_spp_recruits",
  "lam_setchellii_juveniles", 
  "pterygophora_juveniles", 
  "lam_setchellii_adults", 
  "pterygophora_adults", 
  "nereocystis_juveniles", 
  "nereocystis_adults", 
  "macrocystis_recruits", 
  "macrocystis_juveniles", 
  "macrocystis_adults"
)

alg_density_long_for <- alg_density_long_for %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


algal_density_summary_for <- alg_density_long_for %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

algal_density_tornado_2 <- algal_density_summary_for %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(algal_density_tornado_2, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "forestgreen", "2025" = "#1f77b4")) +
  labs(
    title = "INCIP -> FOR",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "Mean Density (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85")
  )

```

####Cover algae
```{r}
# 4. Filter algae density only (exclude cover & urchins)
cov_density_long_2 <- indv_long_for %>%
  filter(!individual_species %in% c(algae, urchins))

# Define species order for plotting
species_order <- c(
  "articulated_coralline", "crustose_coralline", "encrusting_red",
                   "fleshy_reds", "stephanocystis_adult", "desmerestia_spp"
)

cov_density_long_2 <- cov_density_long_2 %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


cov_density_summary_2 <- cov_density_long_2 %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

# Prepare data for tornado plot
cov_density_tornado_2 <- cov_density_summary_2 %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(cov_density_tornado_2, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "forestgreen", "2025" = "#1f77b4")) +
  labs(
    title = "INCIP -> FOR",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "% Cover (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85"))

```
####Urchin
```{r}
# 4. Filter algae density only (exclude cover & urchins)
urch_density_long_2 <- indv_long_for %>%
  filter(!individual_species %in% c(algae, cover_species))

# Define species order for plotting
species_order <- c("total_purple_urchins", "conceiled_purple_urchins")

urch_density_long_2 <- urch_density_long_2 %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


urch_density_summary_2 <- urch_density_long_2 %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

# Prepare data for tornado plot
urch_density_tornado_2 <- urch_density_summary_2 %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(urch_density_tornado_2, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "forestgreen", "2025" = "#1f77b4")) +
  labs(
    title = "INCIP -> FOR",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "Mean Density (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85"))

```
###Stats (ANOVA)
```{r}
anova_check_log <- function(df) {
  # ANOVA model for each species
  aov_model <- aov(value ~ factor(year), data = df)
  res <- residuals(aov_model)
  shapiro_p <- tryCatch(shapiro.test(res)$p.value, error = function(e) NA)
  levene_p <- tryCatch(leveneTest(value ~ factor(year), data = df)$`Pr(>F)`[1], 
                        error = function(e) NA)
  
  # If assumptions fail, log-transform and rerun
  if(is.na(shapiro_p) | is.na(levene_p) | shapiro_p <= 0.05 | levene_p <= 0.05) {
    df <- df %>% mutate(value = log(value + 1))
    aov_model <- aov(value ~ factor(year), data = df)
    res <- residuals(aov_model)
    shapiro_p <- tryCatch(shapiro.test(res)$p.value, error = function(e) NA)
    levene_p <- tryCatch(leveneTest(value ~ factor(year), data = df)$`Pr(>F)`[1], 
                          error = function(e) NA)
    transformed <- TRUE
  } else {
    transformed <- FALSE
  }
  
  # Extract ANOVA results
  tidy_res <- broom::tidy(aov_model) %>% filter(term == "factor(year)")
  f_val <- tidy_res$statistic
  p_val <- tidy_res$p.value
  
  tibble(
    individual_species = unique(df$individual_species),
    shapiro_p = shapiro_p,
    levene_p = levene_p,
    transformed = transformed,
    F_value = f_val,
    p_value = p_val
  )
}

# Apply function to all species
anova_summary <- indv_long_for %>%
  group_by(individual_species) %>%
  group_modify(~ anova_check_log(.x)) %>%
  ungroup()

# View results
anova_summary

# Format ANOVA summary for the table
anova_table <- anova_summary %>%
  dplyr::select(individual_species, F_value, p_value, transformed) %>%
  mutate(p_value = signif(p_value, 3))  # Round p-values

# Create a table figure
ggtexttable(anova_table,
            rows = NULL,       # remove row names
            theme = ttheme("classic"))
```



##C)
```{r}
bar_for <- patch_trans_data %>%
  filter(str_detect(patch_transition, "BAR.*→ FOR"))
```
```{r}
# 1. Summarize density and cover by patch_transition, zone, site, year
individual_sp_bf <- bar_for %>%
  group_by(patch_transition, zone, site, year) %>%
  summarise(across(
    c(macro_stipe_density_.x, macj_densitym2, macr_densitym2, density_nerlue, nerj_densitym2,
      density_ptecal, ptej_densitym2, lamr_densitym2, density_lamset, lsetj_densitym2,
      purple_urchin_densitym2, purple_urchin_conceiledm2, cov_articulated_coralline,
      cov_crustose_coralline, cov_encrusting_red, cov_fleshy_red, cov_stephanocystis,
      cov_desmarestia_spp),
    sum,
    .names = "{.col}"
  )) %>%
  rename(
    macrocystis_adults = macro_stipe_density_.x,
    macrocystis_juveniles = macj_densitym2,
    macrocystis_recruits = macr_densitym2,
    nereocystis_adults = density_nerlue,
    nereocystis_juveniles = nerj_densitym2,
    pterygophora_adults = density_ptecal,
    pterygophora_juveniles = ptej_densitym2,
    laminariales_spp_recruits = lamr_densitym2,
    lam_setchellii_adults = density_lamset,
    lam_setchellii_juveniles = lsetj_densitym2,
    total_purple_urchins = purple_urchin_densitym2,
    conceiled_purple_urchins = purple_urchin_conceiledm2,
    articulated_coralline = cov_articulated_coralline,
    crustose_coralline = cov_crustose_coralline,
    encrusting_red = cov_encrusting_red,
    fleshy_reds = cov_fleshy_red,
    stephanocystis_adult = cov_stephanocystis,
    desmerestia_spp = cov_desmarestia_spp
  ) %>%
  ungroup()

# 2. Pivot longer
indv_long_bf <- individual_sp_bf %>%
  pivot_longer(
    cols = macrocystis_adults:desmerestia_spp,
    names_to = "individual_species",
    values_to = "value"
  ) %>%
  mutate(value_log = log1p(value))  # log-transform for skewed counts

# 3. Define groups
cover_species <- c("articulated_coralline", "crustose_coralline", "encrusting_red",
                   "fleshy_reds", "stephanocystis_adult", "desmerestia_spp")
urchins <- c("total_purple_urchins", "conceiled_purple_urchins")

algae <- c(  "laminariales_spp_recruits",
  "lam_setchellii_juveniles", 
  "pterygophora_juveniles", 
  "lam_setchellii_adults", 
  "pterygophora_adults", 
  "nereocystis_juveniles", 
  "nereocystis_adults", 
  "macrocystis_recruits", 
  "macrocystis_juveniles", 
  "macrocystis_adults")
```
```{r}
alg_density_long_bf <- indv_long_bf %>%
  filter(!individual_species %in% c(cover_species, urchins))

# Define species order for plotting
species_order <- c(
  "laminariales_spp_recruits",
  "lam_setchellii_juveniles", 
  "pterygophora_juveniles", 
  "lam_setchellii_adults", 
  "pterygophora_adults", 
  "nereocystis_juveniles", 
  "nereocystis_adults", 
  "macrocystis_recruits", 
  "macrocystis_juveniles", 
  "macrocystis_adults"
)


alg_density_long_bf <- alg_density_long_bf %>%
  mutate(individual_species = factor(individual_species, levels = species_order))

#Getting SE and SDs
algal_density_summary_bf <- alg_density_long_bf %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )
```
###Plot
####Macroalgae
```{r}
# Prepare data for tornado plot
algal_density_tornado_3 <- algal_density_summary_bf %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(algal_density_tornado_3, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "#d62728", "2025" = "#1f77b4")) +
  labs(
    title = "BAR -> FOR",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "Mean Density (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85")
  )

``` 
####Cover algae
```{r}
# 4. Filter algae density only (exclude cover & urchins)
cov_density_long_3 <- indv_long_bf %>%
  filter(!individual_species %in% c(algae, urchins))

# Define species order for plotting
species_order <- c(
  "articulated_coralline", "crustose_coralline", "encrusting_red",
                   "fleshy_reds", "stephanocystis_adult", "desmerestia_spp"
)

cov_density_long_3 <- cov_density_long_3 %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


cov_density_summary_3 <- cov_density_long_3 %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

# Prepare data for tornado plot
cov_density_tornado_3 <- cov_density_summary_3 %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(cov_density_tornado_3, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "#d62728", "2025" = "#1f77b4")) +
  labs(
    title = "BAR -> FOR",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "% Cover (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85"))

```
####Urchin
```{r}
# 4. Filter algae density only (exclude cover & urchins)
urch_density_long_3 <- indv_long_bf %>%
  filter(!individual_species %in% c(algae, cover_species))

# Define species order for plotting
species_order <- c("total_purple_urchins", "conceiled_purple_urchins")

urch_density_long_3 <- urch_density_long_3 %>%
  mutate(individual_species = factor(individual_species, levels = species_order))


urch_density_summary_3 <- urch_density_long_3 %>%
  group_by(year, individual_species) %>%
  summarise(
    mean_value = mean(value),
    sd_value = sd(value),
    n = n(),
    se_value = sd_value / sqrt(n),
    .groups = "drop" 
  )

# Prepare data for tornado plot
urch_density_tornado_3 <- urch_density_summary_3 %>%
  mutate(
    value_signed = ifelse(year == 2024, -mean_value, mean_value),
    se_signed = ifelse(year == 2024, -se_value, se_value)
  )

# Tornado plot
ggplot(urch_density_tornado_3, 
       aes(x = reorder(individual_species, abs(mean_value)), 
           y = value_signed, 
           fill = factor(year))) +
  geom_col(width = 0.7, color = "gray20") +
  geom_errorbar(aes(ymin = value_signed - se_signed, ymax = value_signed + se_signed),
                width = 0.2, color = "black") +
  coord_flip() +
  scale_y_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c("2024" = "#d62728", "2025" = "#1f77b4")) +
  labs(
    title = "BAR -> FOR",
    subtitle = "2024 (left) vs 2025 (right)",
    x = NULL,
    y = "Mean Density (per m²)",
    fill = "Year"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13, margin = margin(b = 10)),
    axis.text = element_text(color = "black"),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "gray85"))

```
###Stats (ANOVA)
```{r}
anova_check_log <- function(df) {
  # ANOVA model for each species
  aov_model <- aov(value ~ factor(year), data = df)
  res <- residuals(aov_model)
  shapiro_p <- tryCatch(shapiro.test(res)$p.value, error = function(e) NA)
  levene_p <- tryCatch(leveneTest(value ~ factor(year), data = df)$`Pr(>F)`[1], 
                        error = function(e) NA)
  
  # If assumptions fail, log-transform and rerun
  if(is.na(shapiro_p) | is.na(levene_p) | shapiro_p <= 0.05 | levene_p <= 0.05) {
    df <- df %>% mutate(value = log(value + 1))
    aov_model <- aov(value ~ factor(year), data = df)
    res <- residuals(aov_model)
    shapiro_p <- tryCatch(shapiro.test(res)$p.value, error = function(e) NA)
    levene_p <- tryCatch(leveneTest(value ~ factor(year), data = df)$`Pr(>F)`[1], 
                          error = function(e) NA)
    transformed <- TRUE
  } else {
    transformed <- FALSE
  }
  
  # Extract ANOVA results
  tidy_res <- broom::tidy(aov_model) %>% filter(term == "factor(year)")
  f_val <- tidy_res$statistic
  p_val <- tidy_res$p.value
  
  tibble(
    individual_species = unique(df$individual_species),
    shapiro_p = shapiro_p,
    levene_p = levene_p,
    transformed = transformed,
    F_value = f_val,
    p_value = p_val
  )
}

# Apply function to all species
anova_summary <- indv_long_bf %>%
  group_by(individual_species) %>%
  group_modify(~ anova_check_log(.x)) %>%
  ungroup()

# View results
anova_summary

# Format ANOVA summary for the table
anova_table <- anova_summary %>%
  dplyr::select(individual_species, F_value, p_value, transformed) %>%
  mutate(p_value = signif(p_value, 3))  # Round p-values

# Create a table figure
ggtexttable(anova_table,
            rows = NULL,       # remove row names
            theme = ttheme("classic"))
```


  

#FIG 4:
##4a: RDA for BAR -> INCIP
```{r}

# Barren → Incipient
bar_incip <- patch_trans_data %>%
  filter(str_detect(patch_transition, "BAR.*→ INCIP"))


#isolate algal species
algal_cols <- c(
  "cov_articulated_coralline", "cov_crustose_coralline",
  "cov_encrusting_red", "cov_fleshy_red", "cov_lam_holdfast_live",
  "cov_mac_holdfast_live", "cov_dictyoneurum_spp",
  "cov_desmarestia_spp", "cov_stephanocystis",  "macro_stipe_density_.x", "density_ptecal", "density_nerlue", "density_lamset", 
    "density_eisarb", 
    "lamr_densitym2", "macr_densitym2", "macj_densitym2", "nerj_densitym2", 
    "ptej_densitym2", "lsetj_densitym2")


#log + 1 transform 
bar_incip_log <- bar_incip %>%
  mutate(across(all_of(algal_cols), ~ log1p(.)))


bar_incip_long <- bar_incip_log %>%
  pivot_longer(
    cols = all_of(algal_cols),
    names_to = "species",
    values_to = "log_cover"
  )


# Create matrix: rows = samples, columns = algal species
algal_matrix <- bar_incip_log %>%
  dplyr::select(all_of(algal_cols))

# Run NMDS using Bray-Curtis distance
set.seed(42)  # for reproducibility
nmds <- metaMDS(algal_matrix, distance = "bray", k = 2, trymax = 100)

nmds
```